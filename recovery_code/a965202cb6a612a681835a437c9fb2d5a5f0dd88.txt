<template>
  <div class="course-form-page">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
      <el-button :icon="ArrowLeft" @click="goBack">è¿”å›</el-button>
      <h2 class="page-title">{{ isEdit ? 'ç¼–è¾‘è¯¾ç¨‹' : 'åˆ›å»ºè¯¾ç¨‹' }}</h2>
    </div>

    <!-- è¡¨å•å†…å®¹ -->
    <el-card class="form-card" shadow="never">
      <!-- æ ‡ç­¾é¡µ -->
      <el-tabs v-model="activeTab" type="border-card">
        <!-- åŸºæœ¬ä¿¡æ¯æ ‡ç­¾ -->
        <el-tab-pane label="åŸºæœ¬ä¿¡æ¯" name="basic">
          <el-form
            ref="formRef"
            :model="formData"
            :rules="rules"
            label-width="120px"
            label-position="right"
          >
        <!-- è¯¾ç¨‹åç§° -->
        <el-form-item label="è¯¾ç¨‹åç§°" prop="courseName">
          <el-input
            v-model="formData.courseName"
            placeholder="è¯·è¾“å…¥è¯¾ç¨‹åç§°"
            maxlength="100"
            show-word-limit
          />
        </el-form-item>

        <!-- è¯¾ç¨‹æè¿° -->
        <el-form-item label="è¯¾ç¨‹æè¿°" prop="courseDescription">
          <el-input
            v-model="formData.courseDescription"
            type="textarea"
            :rows="4"
            placeholder="è¯·è¾“å…¥è¯¾ç¨‹æè¿°"
            maxlength="500"
            show-word-limit
          />
        </el-form-item>

        <!-- ä¸“ä¸š -->
        <el-form-item label="ä¸“ä¸š" prop="major">
          <el-select v-model="formData.major" placeholder="è¯·é€‰æ‹©ä¸“ä¸š" style="width: 100%">
            <el-option label="è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯" value="è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯" />
            <el-option label="è½¯ä»¶å·¥ç¨‹" value="è½¯ä»¶å·¥ç¨‹" />
            <el-option label="ä¿¡æ¯å®‰å…¨" value="ä¿¡æ¯å®‰å…¨" />
            <el-option label="æ•°æ®ç§‘å­¦ä¸å¤§æ•°æ®æŠ€æœ¯" value="æ•°æ®ç§‘å­¦ä¸å¤§æ•°æ®æŠ€æœ¯" />
            <el-option label="äººå·¥æ™ºèƒ½" value="äººå·¥æ™ºèƒ½" />
            <el-option label="å…¶ä»–" value="å…¶ä»–" />
          </el-select>
        </el-form-item>

        <!-- åˆ†ç±» -->
        <el-form-item label="è¯¾ç¨‹åˆ†ç±»" prop="classification">
          <el-select v-model="formData.classification" placeholder="è¯·é€‰æ‹©åˆ†ç±»" style="width: 100%">
            <el-option label="å¿…ä¿®è¯¾" value="å¿…ä¿®è¯¾" />
            <el-option label="é€‰ä¿®è¯¾" value="é€‰ä¿®è¯¾" />
            <el-option label="å…¬å…±è¯¾" value="å…¬å…±è¯¾" />
            <el-option label="ä¸“ä¸šè¯¾" value="ä¸“ä¸šè¯¾" />
          </el-select>
        </el-form-item>

        <!-- è¯¾ç¨‹æ—¶é—´ -->
        <el-form-item label="è¯¾ç¨‹æ—¶é—´">
          <el-date-picker
            v-model="dateRange"
            type="daterange"
            range-separator="è‡³"
            start-placeholder="å¼€å§‹æ—¥æœŸ"
            end-placeholder="ç»“æŸæ—¥æœŸ"
            format="YYYY-MM-DD"
            value-format="YYYY-MM-DD HH:mm:ss"
            style="width: 100%"
          />
        </el-form-item>

        <!-- è¯¾ç¨‹å°é¢ -->
        <el-form-item label="è¯¾ç¨‹å°é¢">
          <el-upload
            class="cover-uploader"
            :show-file-list="false"
            :before-upload="beforeCoverUpload"
            :on-change="handleCoverChange"
            :auto-upload="false"
            accept="image/*"
          >
            <img v-if="coverPreview" :src="coverPreview" class="cover-preview" />
            <el-icon v-else class="cover-uploader-icon"><Plus /></el-icon>
          </el-upload>
          <div class="upload-tip">å»ºè®®å°ºå¯¸ï¼š800x450pxï¼Œæ”¯æŒjpgã€pngæ ¼å¼ï¼Œå¤§å°ä¸è¶…è¿‡2MB</div>
        </el-form-item>

            <!-- æäº¤æŒ‰é’® -->
            <el-form-item>
              <el-button type="primary" @click="submitForm" :loading="submitting">
                {{ isEdit ? 'ä¿å­˜ä¿®æ”¹' : 'åˆ›å»ºè¯¾ç¨‹' }}
              </el-button>
              <el-button @click="goBack">å–æ¶ˆ</el-button>
            </el-form-item>
          </el-form>
        </el-tab-pane>

        <!-- ç« èŠ‚ç®¡ç†æ ‡ç­¾ -->
        <el-tab-pane label="ç« èŠ‚ç®¡ç†" name="chapters" v-if="isEdit" :disabled="!courseId">
          <div v-loading="chaptersLoading">
            <div class="chapters-header">
              <el-button type="primary" :icon="Plus" @click="openAddDialog(null)">
                æ·»åŠ ç« èŠ‚
              </el-button>
            </div>

            <el-empty v-if="treeData.length === 0" description="æš‚æ— ç« èŠ‚ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ " />
            
            <!-- æ ‘å½¢ç« èŠ‚åˆ—è¡¨ -->
            <el-tree
              v-else
              :data="treeData"
              node-key="chapterId"
              :props="treeProps"
              :expand-on-click-node="false"
              default-expand-all
              class="chapter-tree"
            >
              <template #default="{ node, data }">
                <div class="tree-node">
                  <span class="node-label">
                    <el-icon v-if="data.chapterType === 'FOLDER'" color="#409eff"><Folder /></el-icon>
                    <el-icon v-else-if="data.chapterType === 'VIDEO'" color="#67c23a"><VideoPlay /></el-icon>
                    <el-icon v-else-if="data.chapterType === 'PDF'" color="#e6a23c"><Document /></el-icon>
                    <el-icon v-else color="#909399"><Edit /></el-icon>
                    {{ data.chapterTitle }}
                  </span>
                  <span class="node-actions">
                    <el-button
                      v-if="data.chapterType === 'FOLDER'"
                      size="small"
                      type="primary"
                      link
                      @click.stop="openAddDialog(data)"
                    >
                      <el-icon><Plus /></el-icon>
                      æ·»åŠ å­ç« èŠ‚
                    </el-button>
                    <el-button size="small" link @click.stop="viewChapter(data)">
                      <el-icon><View /></el-icon>
                      æŸ¥çœ‹
                    </el-button>
                    <el-button size="small" type="danger" link @click.stop="deleteChapter(data)">
                      <el-icon><Delete /></el-icon>
                      åˆ é™¤
                    </el-button>
                  </span>
                </div>
              </template>
            </el-tree>
          </div>
        </el-tab-pane>
      </el-tabs>
    </el-card>

    <!-- æ·»åŠ ç« èŠ‚å¯¹è¯æ¡† -->
    <el-dialog
      v-model="addDialogVisible"
      :title="currentParent ? `æ·»åŠ å­ç« èŠ‚åˆ°: ${currentParent.chapterTitle}` : 'æ·»åŠ ç« èŠ‚'"
      width="600px"
    >
      <el-form :model="chapterForm" label-width="100px">
        <el-form-item label="ç« èŠ‚ç±»å‹">
          <el-radio-group v-model="chapterForm.type">
            <el-radio label="FOLDER">ğŸ“ æ–‡ä»¶å¤¹</el-radio>
            <el-radio label="MIXED">ğŸ“š æ··åˆå†…å®¹ï¼ˆè§†é¢‘+PDF+æ–‡æœ¬ï¼‰</el-radio>
            <el-radio label="VIDEO">ğŸ¬ ä»…è§†é¢‘</el-radio>
            <el-radio label="PDF">ğŸ“„ ä»…PDF</el-radio>
            <el-radio label="TEXT">ğŸ“ ä»…æ–‡æœ¬</el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="ç« èŠ‚åç§°" required>
          <el-input v-model="chapterForm.title" placeholder="è¯·è¾“å…¥ç« èŠ‚åç§°" />
        </el-form-item>

        <el-form-item label="ç« èŠ‚é¡ºåº">
          <el-input-number v-model="chapterForm.order" :min="1" />
        </el-form-item>

        <!-- æ··åˆå†…å®¹ - è§†é¢‘ä¸Šä¼  -->
        <el-form-item v-if="chapterForm.type === 'MIXED' || chapterForm.type === 'VIDEO'" label="è§†é¢‘æ–‡ä»¶">
          <el-upload
              ref="videoUploadRef" :auto-upload="false"
            :limit="1"
            :on-change="handleVideoChange"
            accept="video/*"
          >
            <el-button>é€‰æ‹©è§†é¢‘ï¼ˆå¯é€‰ï¼‰</el-button>
            <template #tip>
              <div class="el-upload__tip">æ”¯æŒ mp4ã€aviã€movã€wmv æ ¼å¼ï¼Œæœ€å¤§ 500MB</div>
            </template>
          </el-upload>
        </el-form-item>

        <!-- æ··åˆå†…å®¹ - PDFä¸Šä¼  -->
        <el-form-item v-if="chapterForm.type === 'MIXED' || chapterForm.type === 'PDF'" label="PDFæ–‡ä»¶">
          <el-upload
            :auto-upload="false"
            :limit="1"
            :on-change="handlePdfChange"
            accept=".pdf"
          >
            <el-button>é€‰æ‹©PDFï¼ˆå¯é€‰ï¼‰</el-button>
            <template #tip>
              <div class="el-upload__tip">æ”¯æŒ PDF æ ¼å¼ï¼Œæœ€å¤§ 50MB</div>
            </template>
          </el-upload>
        </el-form-item>

        <!-- æ··åˆå†…å®¹ - æ–‡æœ¬å†…å®¹ -->
        <el-form-item v-if="chapterForm.type === 'MIXED' || chapterForm.type === 'TEXT'" label="æ–‡æœ¬å†…å®¹">
          <el-input
            v-model="chapterForm.content"
            type="textarea"
            :rows="4"
            placeholder="è¯·è¾“å…¥æ–‡æœ¬å†…å®¹ï¼ˆå¯é€‰ï¼‰"
          />
        </el-form-item>
      </el-form>

      <template #footer>
        <el-button @click="addDialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="submitChapter" :loading="chaptersLoading">
          åˆ›å»º
        </el-button>
      </template>
    </el-dialog>

    <!-- ç« èŠ‚è¯¦æƒ…å…¨å±é¡µé¢ -->
    <el-dialog 
      v-model="detailDialogVisible" 
      :title="currentChapter?.chapterTitle || 'ç« èŠ‚è¯¦æƒ…'" 
      width="95%"
      top="3vh"
      :close-on-click-modal="false"
      class="chapter-detail-dialog"
    >
      <div v-if="currentChapter" class="chapter-detail-container">
        <!-- å·¦ä¾§ç« èŠ‚ç›®å½• -->
        <div class="chapter-sidebar">
          <div class="sidebar-header">
            <h3>ç›®å½•</h3>
          </div>
          <div class="sidebar-search">
            <el-input 
              v-model="chapterSearchText" 
              placeholder="æœç´¢" 
              :prefix-icon="Search"
              clearable
            />
          </div>
          <div class="sidebar-tree">
            <el-tree
              :data="treeData"
              node-key="chapterId"
              :props="treeProps"
              :expand-on-click-node="false"
              :highlight-current="true"
              :current-node-key="currentChapter.chapterId"
              @node-click="handleChapterClick"
              default-expand-all
            >
              <template #default="{ node, data }">
                <div class="sidebar-tree-node">
                  <el-icon v-if="data.chapterType === 'FOLDER'" color="#409eff"><Folder /></el-icon>
                  <el-icon v-else-if="data.chapterType === 'VIDEO'" color="#67c23a"><VideoPlay /></el-icon>
                  <el-icon v-else-if="data.chapterType === 'PDF'" color="#e6a23c"><Document /></el-icon>
                  <el-icon v-else color="#909399"><Edit /></el-icon>
                  <span class="tree-node-title">{{ data.chapterTitle }}</span>
                  <el-icon v-if="data.chapterId === currentChapter.chapterId" color="#67c23a" class="check-icon">
                    <Check />
                  </el-icon>
                </div>
              </template>
            </el-tree>
          </div>
        </div>

        <!-- å³ä¾§ç« èŠ‚å†…å®¹ -->
        <div class="chapter-content">
          <div class="content-header">
            <div class="content-title">
              <h2>{{ currentChapter.chapterTitle }}</h2>
              <el-tag :type="getChapterTypeTag(currentChapter.chapterType)">
                {{ getTypeLabel(currentChapter.chapterType) }}
              </el-tag>
            </div>
            <div class="content-meta">
              <span>åˆ›å»ºæ—¶é—´ï¼š{{ formatTime(currentChapter.createTime) }}</span>
            </div>
          </div>

          <div class="content-body">
            <!-- è§†é¢‘æ’­æ”¾ -->
            <div v-if="currentChapter.videoUrl" class="media-section">
              <div class="media-wrapper">
                <video 
                  :src="getMediaUrl(currentChapter.videoUrl)" 
                  controls 
                  controlslist="nodownload"
                  class="video-player"
                >
                  æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
              </div>
            </div>

            <!-- PDFå†…å®¹ -->
            <div v-if="currentChapter.pdfUrl" class="media-section">
              <div class="pdf-viewer">
                <div class="pdf-header">
                  <h3>
                    <el-icon><Document /></el-icon>
                    PDFæ–‡æ¡£
                  </h3>
                  <el-button 
                    type="primary" 
                    :icon="Download" 
                    @click="downloadPdf(currentChapter.pdfUrl)"
                  >
                    ä¸‹è½½PDF
                  </el-button>
                </div>
                <iframe 
                  v-if="currentChapter.pdfUrl"
                  :src="getMediaUrl(currentChapter.pdfUrl)" 
                  class="pdf-frame"
                  frameborder="0"
                ></iframe>
              </div>
            </div>

            <!-- æ–‡æœ¬å†…å®¹ -->
            <div v-if="currentChapter.textContent" class="text-section">
              <div class="text-content-box">
                <div class="text-content-inner" v-html="formatTextContent(currentChapter.textContent)"></div>
              </div>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <el-empty 
              v-if="!currentChapter.videoUrl && !currentChapter.pdfUrl && !currentChapter.textContent"
              description="è¯¥ç« èŠ‚æš‚æ— å†…å®¹"
            />
          </div>
        </div>
      </div>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, computed, watch } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { ArrowLeft, Plus, Folder, VideoPlay, Document, Edit, View, Delete, Search, Check, Download } from '@element-plus/icons-vue'
import { 
  createCourse, 
  getCourseDetail, 
  updateCourse,
  getCourseChapters,
  createFolderChapter,
  createVideoChapter,
  createPdfChapter,
  createTextChapter,
  createMixedChapter,
  getChapterDetail,
  deleteChapter as deleteChapterApi
} from '@/api/course.js'
import { API_BASE_URL } from '@/api/request.js'
const videoUploadRef = ref()
// è·å–åŸºç¡€URL (å»é™¤/apiåç¼€)
const BASE_URL = API_BASE_URL.replace('/api', '')

const route = useRoute()
const router = useRouter()
const formRef = ref()

// åˆ¤æ–­æ˜¯ç¼–è¾‘è¿˜æ˜¯åˆ›å»º
const isEdit = computed(() => route.params.id && route.params.id !== 'create')
const courseId = computed(() => route.params.id)

// æ ‡ç­¾é¡µ
const activeTab = ref('basic')

// è¡¨å•æ•°æ®
const formData = reactive({
  courseName: '',
  courseDescription: '',
  major: '',
  classification: '',
  image: null
})

// æ—¥æœŸèŒƒå›´
const dateRange = ref([])

// å°é¢é¢„è§ˆ
const coverPreview = ref('')
const coverFile = ref(null)

// æäº¤çŠ¶æ€
const submitting = ref(false)

// ==================== ç« èŠ‚ç®¡ç†ç›¸å…³ ====================
const treeData = ref([])
const chaptersLoading = ref(false)
const addDialogVisible = ref(false)
const detailDialogVisible = ref(false)
const currentParent = ref(null)
const currentChapter = ref(null)
const chapterSearchText = ref('')

const treeProps = {
  children: 'children',
  label: 'chapterTitle'
}

const chapterForm = ref({
  type: 'MIXED',
  title: '',
  order: 1,
  video: null,
  pdf: null,
  content: ''
})

// è¡¨å•éªŒè¯è§„åˆ™
const rules = {
  courseName: [
    { required: true, message: 'è¯·è¾“å…¥è¯¾ç¨‹åç§°', trigger: 'blur' },
    { min: 2, max: 100, message: 'è¯¾ç¨‹åç§°é•¿åº¦åœ¨2-100ä¸ªå­—ç¬¦', trigger: 'blur' }
  ],
  courseDescription: [
    { max: 500, message: 'è¯¾ç¨‹æè¿°ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦', trigger: 'blur' }
  ]
}

// åŠ è½½è¯¾ç¨‹è¯¦æƒ…ï¼ˆç¼–è¾‘æ¨¡å¼ï¼‰
const loadCourseDetail = async () => {
  try {
    const response = await getCourseDetail(route.params.id)
    if (response.success && response.data) {
      const course = response.data
      formData.courseName = course.courseName || course.name
      formData.courseDescription = course.courseDescription || course.taskDescribe
      formData.major = course.major || ''
      formData.classification = course.classification || ''
      
      // è®¾ç½®æ—¥æœŸèŒƒå›´
      if (course.startTime && course.endTime) {
        dateRange.value = [course.startTime, course.endTime]
      }
      
      // è®¾ç½®å°é¢é¢„è§ˆ
      if (course.image) {
        coverPreview.value = getCourseImage(course.image)
      }
    }
  } catch (error) {
    console.error('åŠ è½½è¯¾ç¨‹è¯¦æƒ…å¤±è´¥:', error)
    ElMessage.error('åŠ è½½è¯¾ç¨‹è¯¦æƒ…å¤±è´¥')
  }
}

// è·å–è¯¾ç¨‹å›¾ç‰‡URL
const getCourseImage = (image) => {
  if (!image) return ''
  if (image.startsWith('http://') || image.startsWith('https://')) {
    return image
  }
  return `${BASE_URL}${image}`
}

// å°é¢ä¸Šä¼ å‰éªŒè¯
const beforeCoverUpload = (file) => {
  const isImage = file.type.startsWith('image/')
  const isLt2M = file.size / 1024 / 1024 < 2

  if (!isImage) {
    ElMessage.error('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶!')
    return false
  }
  if (!isLt2M) {
    ElMessage.error('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB!')
    return false
  }
  return true
}

// å°é¢é€‰æ‹©
const handleCoverChange = (file) => {
  coverFile.value = file.raw
  
  // é¢„è§ˆ
  const reader = new FileReader()
  reader.onload = (e) => {
    coverPreview.value = e.target.result
  }
  reader.readAsDataURL(file.raw)
}

// æäº¤è¡¨å•
const submitForm = async () => {
  try {
    // è¡¨å•éªŒè¯
    await formRef.value.validate()
    
    submitting.value = true
    
    // è·å–æ•™å¸ˆä¿¡æ¯
    const teacherId = localStorage.getItem('teacherId') || localStorage.getItem('t_id')
    const teacherName = localStorage.getItem('teacherName') || 'æ•™å¸ˆ'
    
    if (!teacherId) {
      ElMessage.warning('è¯·å…ˆç™»å½•')
      router.push('/login')
      return
    }
    
    // å‡†å¤‡æäº¤æ•°æ®
    const submitData = {
      courseName: formData.courseName,
      teacherId: teacherId,
      teacherName: teacherName,
      courseDescription: formData.courseDescription,
      major: formData.major,
      classification: formData.classification,
      creatorUsername: teacherName
    }
    
    // æ·»åŠ æ—¥æœŸèŒƒå›´
    if (dateRange.value && dateRange.value.length === 2) {
      submitData.startTime = dateRange.value[0]
      submitData.endTime = dateRange.value[1]
    }
    
    // æ·»åŠ å°é¢
    if (coverFile.value) {
      submitData.image = coverFile.value
    }
    
    let response
    if (isEdit.value) {
      // ç¼–è¾‘æ¨¡å¼
      response = await updateCourse(route.params.id, submitData)
    } else {
      // åˆ›å»ºæ¨¡å¼
      response = await createCourse(submitData)
    }
    
    if (response.success) {
      ElMessage.success(isEdit.value ? 'è¯¾ç¨‹æ›´æ–°æˆåŠŸ' : 'è¯¾ç¨‹åˆ›å»ºæˆåŠŸ')
      router.push('/teacher/courses')
    } else {
      ElMessage.error(response.message || 'æ“ä½œå¤±è´¥')
    }
  } catch (error) {
    if (error.errors) {
      // è¡¨å•éªŒè¯é”™è¯¯
      return
    }
    console.error('æäº¤å¤±è´¥:', error)
    ElMessage.error('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    submitting.value = false
  }
}

// è¿”å›
const goBack = () => {
  router.push('/teacher/courses')
}

// ==================== ç« èŠ‚ç®¡ç†åŠŸèƒ½ ====================

// è·å–ç« èŠ‚åˆ—è¡¨å¹¶æ„å»ºæ ‘å½¢ç»“æ„
const fetchChapters = async () => {
  if (!courseId.value || courseId.value === 'create') return
  
  chaptersLoading.value = true
  try {
    const response = await getCourseChapters(courseId.value)
    if (response.success) {
      treeData.value = buildTree(response.data)
    }
  } catch (error) {
    console.error('è·å–ç« èŠ‚å¤±è´¥:', error)
    ElMessage.error('è·å–ç« èŠ‚å¤±è´¥')
  } finally {
    chaptersLoading.value = false
  }
}

// æ„å»ºæ ‘å½¢ç»“æ„
const buildTree = (chapters) => {
  const map = {}
  const roots = []

  chapters.forEach(chapter => {
    map[chapter.chapterId] = { ...chapter, children: [] }
  })

  chapters.forEach(chapter => {
    if (chapter.parentId) {
      if (map[chapter.parentId]) {
        map[chapter.parentId].children.push(map[chapter.chapterId])
      }
    } else {
      roots.push(map[chapter.chapterId])
    }
  })

  return roots
}

// æ‰“å¼€æ·»åŠ å¯¹è¯æ¡†
const openAddDialog = (parent) => {
  currentParent.value = parent
  chapterForm.value = {
    type: 'MIXED',
    title: '',
    order: parent ? parent.children.length + 1 : treeData.value.length + 1,
    video: null,
    pdf: null,
    content: ''
  }
  if (videoUploadRef.value) {
    videoUploadRef.value.clearFiles()
  }
  addDialogVisible.value = true
}

// æ–‡ä»¶é€‰æ‹©
const handleVideoChange = (file) => {
  console.log('ğŸ“ è§†é¢‘æ–‡ä»¶é€‰æ‹©äº‹ä»¶è§¦å‘')
  console.log('  fileå‚æ•°:', file)
  console.log('  file.raw:', file.raw)
  console.log('  file.rawç±»å‹:', file.raw instanceof File)
  
  if (file.raw) {
    chapterForm.value.video = file.raw
    console.log('âœ… è§†é¢‘æ–‡ä»¶å·²ä¿å­˜åˆ°chapterForm.value.video')
    console.log('  æ–‡ä»¶å:', chapterForm.value.video.name)
    console.log('  æ–‡ä»¶å¤§å°:', chapterForm.value.video.size, 'bytes')
    console.log('  æ–‡ä»¶ç±»å‹:', chapterForm.value.video.type)
  } else {
    console.error('âŒ file.raw ä¸ºç©º!')
  }
}

const handlePdfChange = (file) => {
  if (file.raw) {
    chapterForm.value.pdf = file.raw
    console.log('âœ… PDFæ–‡ä»¶å·²ä¿å­˜:', file.raw.name)
  }
}

// æäº¤ç« èŠ‚
const submitChapter = async () => {
  if (!chapterForm.value.title) {
    ElMessage.warning('è¯·è¾“å…¥ç« èŠ‚åç§°')
    return
  }

  // ========== æ–‡ä»¶éªŒè¯ ==========
  if (chapterForm.value.type === 'VIDEO') {
    if (!chapterForm.value.video) {
      ElMessage.warning('è§†é¢‘ç« èŠ‚å¿…é¡»ä¸Šä¼ è§†é¢‘æ–‡ä»¶')
      return
    }
    console.log('âœ… è§†é¢‘æ–‡ä»¶å·²é€‰æ‹©:', {
      name: chapterForm.value.video.name,
      size: chapterForm.value.video.size,
      type: chapterForm.value.video.type
    })
  }
  
  if (chapterForm.value.type === 'MIXED') {
    const hasVideo = !!chapterForm.value.video
    const hasPdf = !!chapterForm.value.pdf
    const hasContent = !!chapterForm.value.content
    
    if (!hasVideo && !hasPdf && !hasContent) {
      ElMessage.warning('æ··åˆå†…å®¹è‡³å°‘éœ€è¦ä¸Šä¼ ä¸€ç§å†…å®¹(è§†é¢‘/PDF/æ–‡æœ¬)')
      return
    }
    
    console.log('âœ… æ··åˆå†…å®¹éªŒè¯:', {
      è§†é¢‘: hasVideo ? chapterForm.value.video.name : 'æ— ',
      PDF: hasPdf ? chapterForm.value.pdf.name : 'æ— ',
      æ–‡æœ¬: hasContent ? 'æœ‰' : 'æ— '
    })
  }

  chaptersLoading.value = true
  try {
    const data = {
      courseId: courseId.value,
      parentId: currentParent.value?.chapterId,
      title: chapterForm.value.title,
      order: chapterForm.value.order
    }
    
    // ========== è¯¦ç»†æ—¥å¿— ==========
    console.log('\n=== å‰ç«¯æäº¤ç« èŠ‚ ===')
    console.log('ç« èŠ‚ç±»å‹:', chapterForm.value.type)
    console.log('ç« èŠ‚æ ‡é¢˜:', chapterForm.value.title)
    console.log('è¯¾ç¨‹ID:', data.courseId)
    
    let response
    switch (chapterForm.value.type) {
      case 'FOLDER':
        console.log('ğŸ“ åˆ›å»ºæ–‡ä»¶å¤¹ç« èŠ‚')
        response = await createFolderChapter(data)
        break
      case 'VIDEO':
        data.video = chapterForm.value.video
        console.log('ğŸ¬ åˆ›å»ºè§†é¢‘ç« èŠ‚')
        console.log('  chapterForm.value.video:', chapterForm.value.video)
        console.log('  data.video:', data.video)
        console.log('  data.video æ˜¯Fileå¯¹è±¡:', data.video instanceof File)
        if (data.video) {
          console.log('  è§†é¢‘æ–‡ä»¶è¯¦æƒ…:', {
            name: data.video.name,
            size: data.video.size + ' bytes',
            type: data.video.type,
            lastModified: data.video.lastModified
          })
        } else {
          console.error('âŒ data.video ä¸º null æˆ– undefined!')
        }
        response = await createVideoChapter(data)
        break
      case 'PDF':
        data.pdf = chapterForm.value.pdf
        console.log('ğŸ“„ åˆ›å»ºPDFç« èŠ‚')
        console.log('  PDFæ–‡ä»¶:', data.pdf ? data.pdf.name : 'æ— ')
        response = await createPdfChapter(data)
        break
      case 'TEXT':
        data.content = chapterForm.value.content
        console.log('ğŸ“ åˆ›å»ºæ–‡æœ¬ç« èŠ‚')
        response = await createTextChapter(data)
        break
      case 'MIXED':
        data.video = chapterForm.value.video
        data.pdf = chapterForm.value.pdf
        data.content = chapterForm.value.content
        console.log('ğŸ“š åˆ›å»ºæ··åˆç« èŠ‚')
        console.log('  è§†é¢‘:', data.video ? data.video.name : 'æ— ')
        console.log('  PDF:', data.pdf ? data.pdf.name : 'æ— ')
        console.log('  æ–‡æœ¬:', data.content ? 'æœ‰' : 'æ— ')
        response = await createMixedChapter(data)
        break
    }

    console.log('æœåŠ¡å™¨å“åº”:', response)
    console.log('=== è¯·æ±‚å®Œæˆ ===\n')
    
    if (response.success) {
      ElMessage.success('ç« èŠ‚åˆ›å»ºæˆåŠŸ')
      addDialogVisible.value = false
      fetchChapters()
    } else {
      ElMessage.error(response.message || 'åˆ›å»ºå¤±è´¥')
    }
  } catch (error) {
    console.error('âŒ åˆ›å»ºå¤±è´¥:', error)
    console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data || error.message)
    ElMessage.error('åˆ›å»ºå¤±è´¥: ' + (error.response?.data?.message || error.message))
  } finally {
    chaptersLoading.value = false
  }
}

// æŸ¥çœ‹ç« èŠ‚
const viewChapter = async (chapter) => {
  try {
    const response = await getChapterDetail(chapter.chapterId)
    if (response.success) {
      currentChapter.value = response.data
      detailDialogVisible.value = true
    }
  } catch (error) {
    console.error('è·å–è¯¦æƒ…å¤±è´¥:', error)
    ElMessage.error('è·å–è¯¦æƒ…å¤±è´¥')
  }
}

// åˆ é™¤ç« èŠ‚
const deleteChapter = async (chapter) => {
  try {
    await ElMessageBox.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç« èŠ‚å—ï¼Ÿ', 'ç¡®è®¤åˆ é™¤', {
      confirmButtonText: 'ç¡®å®š',
      cancelButtonText: 'å–æ¶ˆ',
      type: 'warning'
    })

    const response = await deleteChapterApi(chapter.chapterId)
    if (response.success) {
      ElMessage.success('åˆ é™¤æˆåŠŸ')
      fetchChapters()
    } else {
      ElMessage.error(response.message || 'åˆ é™¤å¤±è´¥')
    }
  } catch (error) {
    if (error !== 'cancel') {
      console.error('åˆ é™¤å¤±è´¥:', error)
      ElMessage.error('åˆ é™¤å¤±è´¥')
    }
  }
}

// å¤„ç†ç« èŠ‚ç‚¹å‡»
const handleChapterClick = async (chapter) => {
  if (chapter.chapterType === 'FOLDER') {
    return // æ–‡ä»¶å¤¹ä¸åŠ è½½è¯¦æƒ…
  }
  await viewChapter(chapter)
}

// è·å–åª’ä½“URL
const getMediaUrl = (url) => {
  if (!url) return ''
  if (url.startsWith('http://') || url.startsWith('https://')) {
    return url
  }
  return `${BASE_URL}${url}`
}

// ä¸‹è½½PDF
const downloadPdf = (url) => {
  const fullUrl = getMediaUrl(url)
  window.open(fullUrl, '_blank')
}

// æ ¼å¼åŒ–æ–‡æœ¬å†…å®¹ï¼ˆæ”¯æŒæ¢è¡Œï¼‰
const formatTextContent = (text) => {
  if (!text) return ''
  return text.replace(/\n/g, '<br>')
}

// è·å–ç« èŠ‚ç±»å‹æ ‡ç­¾é¢œè‰²
const getChapterTypeTag = (type) => {
  const tags = {
    FOLDER: 'info',
    VIDEO: 'success',
    PDF: 'warning',
    TEXT: '',
    MIXED: 'primary'
  }
  return tags[type] || ''
}

// å·¥å…·å‡½æ•°
const getTypeLabel = (type) => {
  const types = {
    FOLDER: 'æ–‡ä»¶å¤¹',
    VIDEO: 'è§†é¢‘',
    PDF: 'PDF',
    TEXT: 'æ–‡æœ¬',
    MIXED: 'æ··åˆå†…å®¹'
  }
  return types[type] || type
}

const formatTime = (time) => {
  if (!time) return ''
  return new Date(time).toLocaleString('zh-CN')
}

// ç›‘å¬æ ‡ç­¾é¡µåˆ‡æ¢ï¼ŒåŠ è½½ç« èŠ‚æ•°æ®
watch(activeTab, (newTab) => {
  if (newTab === 'chapters' && isEdit.value) {
    fetchChapters()
  }
})

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  if (isEdit.value) {
    loadCourseDetail()
  }
})
</script>

<style scoped>
.course-form-page {
  padding: 20px;
  background-color: #f5f7fa;
  min-height: 100vh;
}

.page-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background-color: #fff;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.page-title {
  flex: 1;
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: #303133;
}

.form-card {
  max-width: 800px;
  margin: 0 auto;
}

.cover-uploader {
  width: 300px;
  height: 180px;
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: all 0.3s;
}

.cover-uploader:hover {
  border-color: #409eff;
}

.cover-preview {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.cover-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.upload-tip {
  margin-top: 8px;
  font-size: 12px;
  color: #909399;
  line-height: 1.5;
}

/* ç« èŠ‚ç®¡ç†æ ·å¼ */
.chapters-header {
  margin-bottom: 20px;
  display: flex;
  justify-content: flex-end;
}

.chapter-tree {
  margin-top: 20px;
}

.tree-node {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding-right: 20px;
}

.node-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.node-actions {
  display: flex;
  gap: 4px;
  align-items: center;
}

.el-upload__tip {
  font-size: 12px;
  color: #909399;
  margin-top: 4px;
}

/* ç« èŠ‚è¯¦æƒ…å…¨å±æ ·å¼ */
.chapter-detail-dialog :deep(.el-dialog__body) {
  padding: 0;
  height: 85vh;
}

.chapter-detail-container {
  display: flex;
  height: 100%;
  background-color: #f5f7fa;
}

/* å·¦ä¾§ç« èŠ‚ç›®å½• */
.chapter-sidebar {
  width: 300px;
  background-color: #fff;
  border-right: 1px solid #e4e7ed;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid #e4e7ed;
}

.sidebar-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #303133;
}

.sidebar-search {
  padding: 15px;
  border-bottom: 1px solid #e4e7ed;
}

.sidebar-tree {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.sidebar-tree-node {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  padding: 5px 0;
}

.tree-node-title {
  flex: 1;
  font-size: 14px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.check-icon {
  margin-left: auto;
}

.sidebar-tree :deep(.el-tree-node__content) {
  height: auto;
  padding: 8px 0;
}

.sidebar-tree :deep(.el-tree-node__content:hover) {
  background-color: #f5f7fa;
}

.sidebar-tree :deep(.is-current > .el-tree-node__content) {
  background-color: #ecf5ff;
  color: #409eff;
}

/* å³ä¾§ç« èŠ‚å†…å®¹ */
.chapter-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background-color: #fff;
  margin: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

.content-header {
  padding: 24px;
  border-bottom: 1px solid #e4e7ed;
  background-color: #fff;
}

.content-title {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.content-title h2 {
  margin: 0;
  font-size: 24px;
  font-weight: 600;
  color: #303133;
}

.content-meta {
  font-size: 14px;
  color: #909399;
}

.content-body {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

/* åª’ä½“åŒºåŸŸ */
.media-section {
  margin-bottom: 24px;
}

.media-wrapper {
  background-color: #000;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
}

.video-player {
  width: 100%;
  max-height: 600px;
  display: block;
}

/* PDFæŸ¥çœ‹å™¨ */
.pdf-viewer {
  background-color: #fff;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #e4e7ed;
}

.pdf-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background-color: #f5f7fa;
  border-bottom: 1px solid #e4e7ed;
}

.pdf-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #303133;
  display: flex;
  align-items: center;
  gap: 8px;
}

.pdf-frame {
  width: 100%;
  height: 700px;
  border: none;
  background-color: #fff;
}

/* æ–‡æœ¬å†…å®¹ */
.text-section {
  margin-bottom: 24px;
}

.text-content-box {
  background-color: #fff;
  border: 1px solid #e4e7ed;
  border-radius: 8px;
  padding: 24px;
}

.text-content-inner {
  font-size: 15px;
  line-height: 1.8;
  color: #303133;
  white-space: pre-wrap;
  word-wrap: break-word;
}
</style>
